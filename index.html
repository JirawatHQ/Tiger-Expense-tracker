<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üí∞ Tiger Expense</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --bg:#07070d;--s:rgba(255,255,255,0.035);--s2:rgba(255,255,255,0.065);--s3:rgba(255,255,255,0.1);
  --bd:rgba(255,255,255,0.08);--bdh:rgba(255,255,255,0.16);
  --t:#eaeaf0;--td:#6a6a82;--tm:#9a9ab0;
  --grn:#34d399;--grn-g:rgba(52,211,153,0.12);--red:#fb7185;--red-g:rgba(251,113,133,0.12);
  --blue:#60a5fa;--purple:#a78bfa;--orange:#fb923c;--yellow:#fbbf24;--teal:#2dd4bf;
  --ns:#c2555a;--ns-g:rgba(194,85,90,0.12);
  --ew:#f59e0b;--ew-g:rgba(245,158,11,0.12);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:'Sarabun',sans-serif;background:var(--bg);color:var(--t)}

.app{
  display:flex;flex-direction:column;
  height:100vh;height:100dvh;
  max-width:520px;margin:0 auto;
  padding:6px 10px 0;
  overflow:hidden;
}

/* ‚îÄ‚îÄ‚îÄ Top Bar ‚îÄ‚îÄ‚îÄ */
.top{display:flex;align-items:center;justify-content:space-between;padding:4px 0;flex-shrink:0}
.prof-sw{display:flex;gap:4px}
.pb{
  display:flex;align-items:center;gap:5px;
  padding:5px 12px;border-radius:20px;
  border:1.5px solid var(--bd);background:var(--s);
  font-size:0.78rem;font-weight:600;color:var(--td);
  cursor:pointer;font-family:'Sarabun',sans-serif;transition:all 0.2s;
}
.pb .av{font-size:0.9rem}
.pb.act[data-u="namsai"]{border-color:var(--ns);background:var(--ns-g);color:var(--t)}
.pb.act[data-u="iew"]{border-color:var(--ew);background:var(--ew-g);color:var(--t)}
.sum-mini{display:flex;gap:10px;font-family:'JetBrains Mono',monospace;font-size:0.7rem}
.sm-item .sm-l{font-size:0.55rem;color:var(--td);font-family:'Sarabun',sans-serif}
.sm-item .sm-v{font-weight:700}
.sm-me .sm-v{color:var(--ns)}
.sm-pt .sm-v{color:var(--ew)}
.sm-tot .sm-v{color:var(--yellow)}

/* ‚îÄ‚îÄ‚îÄ Nav Tabs ‚îÄ‚îÄ‚îÄ */
.nav{display:flex;gap:2px;background:var(--s);border-radius:10px;padding:2px;margin:6px 0;flex-shrink:0;border:1px solid var(--bd)}
.nav-b{
  flex:1;padding:6px;text-align:center;border-radius:8px;
  font-size:0.72rem;font-weight:600;color:var(--td);
  cursor:pointer;border:none;background:none;font-family:'Sarabun',sans-serif;transition:all 0.15s;
}
.nav-b.act{color:var(--bg)}
.nav-b.act.u-namsai{background:var(--ns)}
.nav-b.act.u-iew{background:var(--ew)}

/* ‚îÄ‚îÄ‚îÄ Panels ‚îÄ‚îÄ‚îÄ */
.panels{flex:1;overflow:hidden;position:relative}
.pnl{display:none;height:100%;overflow-y:auto;padding-bottom:10px;
  scrollbar-width:thin;scrollbar-color:var(--bd) transparent;
}
.pnl.act{display:block;animation:fu .2s ease}
@keyframes fu{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.pnl::-webkit-scrollbar{width:3px}
.pnl::-webkit-scrollbar-track{background:transparent}
.pnl::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}

/* ‚îÄ‚îÄ‚îÄ ADD form ‚îÄ‚îÄ‚îÄ */
.fg{margin-bottom:8px}
.fg label{display:block;font-size:0.68rem;font-weight:600;color:var(--td);margin-bottom:3px}
.fg input,.fg select,.fg textarea{
  width:100%;padding:8px 10px;background:var(--s);border:1px solid var(--bd);
  border-radius:9px;color:var(--t);font-family:'Sarabun',sans-serif;font-size:0.88rem;
}
.fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--grn);box-shadow:0 0 0 2px var(--grn-g)}
.fg textarea{resize:none;height:36px;font-size:0.82rem}
.fg select{appearance:none;cursor:pointer}
.aw{position:relative}
.aw .cu{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--td);font-size:0.75rem;font-weight:600}
.aw input{font-family:'JetBrains Mono',monospace;font-size:1.2rem;font-weight:700;padding-right:36px;text-align:right}

.cg{display:grid;grid-template-columns:repeat(4,1fr);gap:5px}
.cb{
  display:flex;flex-direction:column;align-items:center;gap:1px;
  padding:6px 2px;background:var(--s);border:1.5px solid var(--bd);
  border-radius:9px;cursor:pointer;font-family:'Sarabun',sans-serif;transition:all 0.15s;
}
.cb:hover,.cb.sel{border-color:var(--grn);background:var(--grn-g)}
.cb .ce{font-size:1rem}
.cb .ct{font-size:0.55rem;color:var(--td);font-weight:600}
.cb.sel .ct{color:var(--grn)}

.qa{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px}
.qb{
  padding:3px 10px;background:var(--s2);border:1px solid var(--bd);border-radius:14px;
  color:var(--td);font-family:'JetBrains Mono',monospace;font-size:0.65rem;cursor:pointer;
}
.qb:hover{border-color:var(--grn);color:var(--grn)}

.row2{display:grid;grid-template-columns:1fr 1fr;gap:6px}

.btn-s{
  width:100%;padding:10px;border:none;border-radius:10px;
  font-size:0.88rem;font-weight:800;font-family:'Sarabun',sans-serif;
  cursor:pointer;margin-top:4px;transition:all 0.2s;color:#fff;
}
.btn-s.u-namsai{background:linear-gradient(135deg,var(--ns),#a03a3f);box-shadow:0 3px 14px rgba(194,85,90,0.3)}
.btn-s.u-iew{background:linear-gradient(135deg,var(--ew),#d97706);box-shadow:0 3px 14px rgba(245,158,11,0.3)}
.btn-s:active{transform:scale(0.98)}
.btn-s:disabled{opacity:0.5}

/* ‚îÄ‚îÄ‚îÄ History ‚îÄ‚îÄ‚îÄ */
.hf{display:flex;gap:4px;margin-bottom:6px;flex-wrap:wrap}
.hfb{
  padding:3px 10px;background:var(--s2);border:1px solid var(--bd);border-radius:14px;
  color:var(--td);font-size:0.65rem;cursor:pointer;font-family:'Sarabun',sans-serif;
}
.hfb:hover,.hfb.act{border-color:var(--grn);color:var(--grn)}
.ei{
  display:flex;align-items:center;gap:9px;padding:8px 10px;
  background:var(--s);border:1px solid var(--bd);border-radius:10px;margin-bottom:5px;
}
.ei .ic{width:32px;height:32px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:0.95rem;flex-shrink:0}
.ei .inf{flex:1;min-width:0}
.ei .inf .nm{font-size:0.78rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ei .inf .mt{font-size:0.6rem;color:var(--td);margin-top:1px}
.ut{display:inline-block;padding:0px 5px;border-radius:6px;font-size:0.55rem;font-weight:700;margin-right:3px}
.ut-ns{background:var(--ns-g);color:var(--ns)}
.ut-ew{background:var(--ew-g);color:var(--ew)}
.ei .ea{font-family:'JetBrains Mono',monospace;font-size:0.8rem;font-weight:700;color:var(--red);flex-shrink:0}
.empty{text-align:center;padding:24px;color:var(--td);font-size:0.8rem}

/* ‚îÄ‚îÄ‚îÄ Charts ‚îÄ‚îÄ‚îÄ */
.cc{background:var(--s);border:1px solid var(--bd);border-radius:11px;padding:10px;margin-bottom:8px}
.cc h3{font-size:0.75rem;font-weight:700;margin-bottom:6px}
.cc canvas{max-height:160px}
.sg{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px}
.sb{background:var(--s);border:1px solid var(--bd);border-radius:10px;padding:8px;text-align:center}
.sb .sv{font-family:'JetBrains Mono',monospace;font-size:0.95rem;font-weight:700}
.sb .sl{font-size:0.6rem;color:var(--td);margin-top:1px}
.cbar{height:24px;border-radius:6px;overflow:hidden;display:flex;background:var(--s2);margin:6px 0 4px}
.cbar .seg{height:100%;display:flex;align-items:center;justify-content:center;font-size:0.6rem;font-weight:700;color:#fff;transition:width 0.5s}
.seg.ns-s{background:var(--ns)}.seg.ew-s{background:var(--ew)}
.clb{display:flex;justify-content:space-between;font-size:0.65rem;color:var(--td)}

/* ‚îÄ‚îÄ‚îÄ Settings ‚îÄ‚îÄ‚îÄ */
.si{background:var(--s);border:1px solid var(--bd);border-radius:10px;padding:10px;margin-bottom:7px}
.si label{font-size:0.75rem;font-weight:600;display:block;margin-bottom:5px}
.si input{width:100%;padding:7px 9px;background:var(--bg);border:1px solid var(--bd);border-radius:7px;color:var(--t);font-family:'Sarabun',sans-serif;font-size:0.82rem}
.si input:focus{outline:none;border-color:var(--grn)}
.bg{padding:7px 14px;border:none;border-radius:8px;font-weight:700;font-family:'Sarabun',sans-serif;cursor:pointer;font-size:0.82rem;width:100%;margin-top:6px}
.bg-g{background:var(--grn);color:var(--bg)}
.bg-r{background:var(--red);color:#fff}

/* ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ */
.toast{
  position:fixed;top:10px;left:50%;transform:translateX(-50%) translateY(-60px);
  padding:8px 18px;border-radius:9px;font-size:0.78rem;font-weight:600;
  z-index:9999;transition:transform 0.3s;font-family:'Sarabun',sans-serif;
  background:var(--grn);color:var(--bg);max-width:90%;text-align:center;
}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.err{background:var(--red)}
</style>
</head>
<body>
<div class="app">

  <!-- Top Bar -->
  <div class="top">
    <div class="prof-sw">
      <button class="pb act" data-u="namsai" onclick="sw('namsai')"><span class="av">ü¶â</span>‡∏ô‡πâ‡∏≥‡πÉ‡∏™</button>
      <button class="pb" data-u="iew" onclick="sw('iew')"><span class="av">üêØ</span>‡πÄ‡∏≠‡∏µ‡πà‡∏¢‡∏ß</button>
    </div>
    <div class="sum-mini">
      <div class="sm-item sm-me"><div class="sm-l">‡∏â‡∏±‡∏ô</div><div class="sm-v" id="smMe">‡∏ø0</div></div>
      <div class="sm-item sm-pt"><div class="sm-l">‡∏Ñ‡∏π‡πà</div><div class="sm-v" id="smPt">‡∏ø0</div></div>
      <div class="sm-item sm-tot"><div class="sm-l">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div><div class="sm-v" id="smTot">‡∏ø0</div></div>
    </div>
  </div>

  <!-- Nav -->
  <div class="nav">
    <button class="nav-b act u-namsai" onclick="go('add')">‚úèÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
    <button class="nav-b" onclick="go('hist')">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
    <button class="nav-b" onclick="go('chart')">üìä ‡∏™‡∏£‡∏∏‡∏õ</button>
    <button class="nav-b" onclick="go('set')">‚öôÔ∏è</button>
  </div>

  <!-- Panels -->
  <div class="panels">

    <!-- ADD -->
    <div class="pnl act" id="pAdd">
      <div class="fg">
        <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
        <div class="aw">
          <input type="number" id="xAmt" placeholder="0" inputmode="decimal" step="0.01">
          <span class="cu">‡∏ø</span>
        </div>
        <div class="qa">
          <button class="qb" onclick="sa(20)">20</button>
          <button class="qb" onclick="sa(50)">50</button>
          <button class="qb" onclick="sa(100)">100</button>
          <button class="qb" onclick="sa(200)">200</button>
          <button class="qb" onclick="sa(500)">500</button>
          <button class="qb" onclick="sa(1000)">1K</button>
        </div>
      </div>
      <div class="fg">
        <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
        <div class="cg" id="catG"></div>
      </div>
      <div class="fg">
        <label>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label>
        <textarea id="xNote" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."></textarea>
      </div>
      <div class="row2">
        <div class="fg"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="xDate"></div>
        <div class="fg"><label>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</label><select id="xPer"></select></div>
      </div>
      <button class="btn-s u-namsai" id="btnS" onclick="sub()">ü¶â ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏ô‡πâ‡∏≥‡πÉ‡∏™)</button>
    </div>

    <!-- HISTORY -->
    <div class="pnl" id="pHist">
      <div class="hf">
        <button class="hfb act" data-f="all" onclick="sf('all')">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button class="hfb" data-f="namsai" onclick="sf('namsai')">ü¶â ‡∏ô‡πâ‡∏≥‡πÉ‡∏™</button>
        <button class="hfb" data-f="iew" onclick="sf('iew')">üêØ ‡πÄ‡∏≠‡∏µ‡πà‡∏¢‡∏ß</button>
        <button class="hfb" data-f="today" onclick="sf('today')">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        <button class="hfb" data-f="week" onclick="sf('week')">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</button>
      </div>
      <div id="hList"></div>
    </div>

    <!-- CHARTS -->
    <div class="pnl" id="pChart">
      <div class="cc">
        <h3>üë• ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</h3>
        <div class="cbar" id="cBar"><div class="seg ns-s" style="width:50%">50%</div><div class="seg ew-s" style="width:50%">50%</div></div>
        <div class="clb"><span>ü¶â <span id="cN">‡∏ø0</span></span><span>üêØ <span id="cI">‡∏ø0</span></span></div>
      </div>
      <div class="sg">
        <div class="sb"><div class="sv" id="sAvg" style="color:var(--grn)">‡∏ø0</div><div class="sl">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ß‡∏±‡∏ô</div></div>
        <div class="sb"><div class="sv" id="sMax" style="color:var(--red)">‡∏ø0</div><div class="sl">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div></div>
        <div class="sb"><div class="sv" id="sDays" style="color:var(--blue)">0</div><div class="sl">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</div></div>
        <div class="sb"><div class="sv" id="sCnt" style="color:var(--orange)">0</div><div class="sl">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>
      </div>
      <div class="cc"><h3>üìà ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô 7 ‡∏ß‡∏±‡∏ô</h3><canvas id="chD"></canvas></div>
      <div class="cc"><h3>üçï ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3><canvas id="chC"></canvas></div>
      <div class="cc"><h3>üìÖ ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3><canvas id="chM"></canvas></div>
    </div>

    <!-- SETTINGS -->
    <div class="pnl" id="pSet">
      <div class="si">
        <label>üîó Google Apps Script URL</label>
        <input type="text" id="sUrl" placeholder="https://script.google.com/macros/s/...">
        <button class="bg bg-g" onclick="svUrl()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
      <div class="si">
        <label>üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
        <div style="display:flex;gap:6px;margin-top:4px">
          <button class="pb" data-u="namsai" onclick="sw('namsai')" style="flex:1;justify-content:center"><span class="av">ü¶â</span>‡∏ô‡πâ‡∏≥‡πÉ‡∏™</button>
          <button class="pb" data-u="iew" onclick="sw('iew')" style="flex:1;justify-content:center"><span class="av">üêØ</span>‡πÄ‡∏≠‡∏µ‡πà‡∏¢‡∏ß</button>
        </div>
      </div>
      <div class="si">
        <label>üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
        <button class="bg bg-r" onclick="clr()">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>
    </div>

  </div>
</div>

<div class="toast" id="tst"></div>

<script>
const U={namsai:{n:'‡∏ô‡πâ‡∏≥‡πÉ‡∏™',e:'ü¶â',c:'#c2555a'},iew:{n:'‡πÄ‡∏≠‡∏µ‡πà‡∏¢‡∏ß',e:'üêØ',c:'#f59e0b'}};
const C=[
  {id:'food',e:'üçú',l:'‡∏≠‡∏≤‡∏´‡∏≤‡∏£',c:'#fdba74'},{id:'drink',e:'‚òï',l:'‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°',c:'#a78bfa'},
  {id:'transport',e:'üöó',l:'‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á',c:'#60a5fa'},{id:'shopping',e:'üõçÔ∏è',l:'‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á',c:'#f472b6'},
  {id:'health',e:'üíä',l:'‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û',c:'#34d399'},{id:'entertain',e:'üéÆ',l:'‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á',c:'#c4b5fd'},
  {id:'bills',e:'üì±',l:'‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£',c:'#fde68a'},{id:'other',e:'üì¶',l:'‡∏≠‡∏∑‡πà‡∏ô‡πÜ',c:'#94a3b8'}
];

let S={cu:'namsai',url:'',exp:[],sc:'',hf:'all'};
let chD=null,chC=null,chM=null;

function init(){ld();rCat();apu();sDate();ua()}
function ld(){try{const s=localStorage.getItem('te3');if(s){const p=JSON.parse(s);S={...S,...p}}}catch(e){}}
function sv(){try{localStorage.setItem('te3',JSON.stringify({cu:S.cu,url:S.url,exp:S.exp.slice(-500)}))}catch(e){}}

// User switch
function sw(u){S.cu=u;sv();apu();ua()}
function apu(){
  const u=U[S.cu],p=S.cu==='namsai'?'iew':'namsai';
  document.querySelectorAll('.pb').forEach(b=>b.classList.toggle('act',b.dataset.u===S.cu));
  document.querySelectorAll('.nav-b').forEach(b=>{b.classList.remove('u-namsai','u-iew');if(b.classList.contains('act'))b.classList.add('u-'+S.cu)});
  const btn=document.getElementById('btnS');
  btn.className='btn-s u-'+S.cu;
  btn.textContent=`${u.e} ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (${u.n})`;
  const sel=document.getElementById('xPer');
  sel.innerHTML=`<option value="${S.cu}">${u.e} ${u.n}</option><option value="${p}">${U[p].e} ${U[p].n}</option>`;
  document.getElementById('sUrl').value=S.url||'';
}

// Categories
function rCat(){document.getElementById('catG').innerHTML=C.map(c=>`<button class="cb" data-id="${c.id}" onclick="sc('${c.id}')"><span class="ce">${c.e}</span><span class="ct">${c.l}</span></button>`).join('')}
function sc(id){S.sc=id;document.querySelectorAll('.cb').forEach(b=>b.classList.toggle('sel',b.dataset.id===id))}

function sDate(){const n=new Date();document.getElementById('xDate').value=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`}
function sa(v){document.getElementById('xAmt').value=v}

// Submit
async function sub(){
  const amt=parseFloat(document.getElementById('xAmt').value);
  if(!amt||amt<=0){ts('‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô','e');return}
  if(!S.sc){ts('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà','e');return}
  const cat=C.find(c=>c.id===S.sc),n=new Date();
  const exp={date:document.getElementById('xDate').value,time:`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`,amount:amt,catId:S.sc,category:cat.l,emoji:cat.e,note:document.getElementById('xNote').value.trim(),person:document.getElementById('xPer').value,ts:n.toISOString()};
  const btn=document.getElementById('btnS');btn.disabled=true;
  S.exp.push(exp);sv();
  if(S.url){try{await fetch(S.url,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'add',data:exp})});ts('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!')}catch(e){ts('‚ö†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å local','e')}}else{ts('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å local')}
  btn.disabled=false;apu();
  document.getElementById('xAmt').value='';document.getElementById('xNote').value='';
  S.sc='';document.querySelectorAll('.cb').forEach(b=>b.classList.remove('sel'));sDate();ua();
}

function ua(){uSum();rHist();rCharts()}

// Summary
function uSum(){
  const n=new Date(),td=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`,ms=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}`;
  const me=S.cu,pt=me==='namsai'?'iew':'namsai';
  const myT=S.exp.filter(e=>e.date===td&&e.person===me).reduce((s,e)=>s+e.amount,0);
  const ptT=S.exp.filter(e=>e.date===td&&e.person===pt).reduce((s,e)=>s+e.amount,0);
  const tot=S.exp.filter(e=>e.date.startsWith(ms)).reduce((s,e)=>s+e.amount,0);
  document.getElementById('smMe').textContent='‡∏ø'+myT.toLocaleString();
  document.getElementById('smPt').textContent='‡∏ø'+ptT.toLocaleString();
  document.getElementById('smTot').textContent='‡∏ø'+tot.toLocaleString();
}

// History
function sf(f){S.hf=f;document.querySelectorAll('.hfb').forEach(b=>b.classList.toggle('act',b.dataset.f===f));rHist()}
function rHist(){
  const el=document.getElementById('hList'),n=new Date();
  const td=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;
  const wa=new Date(n);wa.setDate(wa.getDate()-7);
  const ws=`${wa.getFullYear()}-${String(wa.getMonth()+1).padStart(2,'0')}-${String(wa.getDate()).padStart(2,'0')}`;
  let it=[...S.exp].reverse(),f=S.hf;
  if(f==='namsai')it=it.filter(e=>e.person==='namsai');
  else if(f==='iew')it=it.filter(e=>e.person==='iew');
  else if(f==='today')it=it.filter(e=>e.date===td);
  else if(f==='week')it=it.filter(e=>e.date>=ws);
  it=it.slice(0,60);
  if(!it.length){el.innerHTML='<div class="empty">üì≠ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';return}
  el.innerHTML=it.map(e=>{
    const cat=C.find(c=>c.id===e.catId||c.l===e.category)||C[7];
    const u=U[e.person]||U.namsai;
    const tc=e.person==='namsai'?'ut-ns':'ut-ew';
    return `<div class="ei"><div class="ic" style="background:${cat.c}18;color:${cat.c}">${e.emoji||cat.e}</div><div class="inf"><div class="nm">${e.note||e.category}</div><div class="mt"><span class="ut ${tc}">${u.e}${u.n}</span>${e.date} ${e.time||''}</div></div><div class="ea">-‡∏ø${e.amount.toLocaleString()}</div></div>`;
  }).join('');
}

// Charts
function rCharts(){rComp();rStats();rDaily();rCatCh();rMonth()}
function rComp(){
  const n=new Date(),ms=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}`;
  const m=S.exp.filter(e=>e.date.startsWith(ms));
  const ns=m.filter(e=>e.person==='namsai').reduce((s,e)=>s+e.amount,0);
  const is=m.filter(e=>e.person==='iew').reduce((s,e)=>s+e.amount,0);
  const t=ns+is||1,np=Math.round(ns/t*100),ip=100-np;
  document.getElementById('cBar').innerHTML=`<div class="seg ns-s" style="width:${np}%">${np}%</div><div class="seg ew-s" style="width:${ip}%">${ip}%</div>`;
  document.getElementById('cN').textContent='‡∏ø'+ns.toLocaleString();
  document.getElementById('cI').textContent='‡∏ø'+is.toLocaleString();
}
function rStats(){
  const n=new Date(),ms=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}`;
  const my=S.exp.filter(e=>e.date.startsWith(ms)&&e.person===S.cu);
  const all=S.exp.filter(e=>e.date.startsWith(ms));
  const days=new Set(my.map(e=>e.date)).size||1;
  const myT=my.reduce((s,e)=>s+e.amount,0);
  document.getElementById('sAvg').textContent='‡∏ø'+Math.round(myT/days).toLocaleString();
  document.getElementById('sMax').textContent='‡∏ø'+(all.length?Math.max(...all.map(e=>e.amount)):0).toLocaleString();
  document.getElementById('sDays').textContent=new Set(all.map(e=>e.date)).size;
  document.getElementById('sCnt').textContent=all.length;
}
function rDaily(){
  const lb=[],dN=[],dI=[],n=new Date();
  for(let i=6;i>=0;i--){const d=new Date(n);d.setDate(d.getDate()-i);const ds=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;lb.push(`${d.getDate()}/${d.getMonth()+1}`);dN.push(S.exp.filter(e=>e.date===ds&&e.person==='namsai').reduce((s,e)=>s+e.amount,0));dI.push(S.exp.filter(e=>e.date===ds&&e.person==='iew').reduce((s,e)=>s+e.amount,0))}
  if(chD)chD.destroy();
  chD=new Chart(document.getElementById('chD'),{type:'bar',data:{labels:lb,datasets:[{label:'‡∏ô‡πâ‡∏≥‡πÉ‡∏™',data:dN,backgroundColor:'rgba(194,85,90,0.75)',borderRadius:4,barPercentage:0.7},{label:'‡πÄ‡∏≠‡∏µ‡πà‡∏¢‡∏ß',data:dI,backgroundColor:'rgba(245,158,11,0.75)',borderRadius:4,barPercentage:0.7}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{labels:{color:'#9a9ab0',font:{size:10,family:'Sarabun'}}}},scales:{x:{stacked:true,ticks:{color:'#6a6a82',font:{size:9}},grid:{display:false}},y:{stacked:true,ticks:{color:'#6a6a82',font:{size:9},callback:v=>'‡∏ø'+v.toLocaleString()},grid:{color:'rgba(255,255,255,0.04)'}}}}});
}
function rCatCh(){
  const n=new Date(),ms=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}`;
  const m=S.exp.filter(e=>e.date.startsWith(ms));
  const cd={};C.forEach(c=>{cd[c.id]=0});m.forEach(e=>{if(cd[e.catId]!==undefined)cd[e.catId]+=e.amount});
  const so=C.filter(c=>cd[c.id]>0).sort((a,b)=>cd[b.id]-cd[a.id]);
  if(chC)chC.destroy();
  chC=new Chart(document.getElementById('chC'),{type:'doughnut',data:{labels:so.map(c=>c.e+' '+c.l),datasets:[{data:so.map(c=>cd[c.id]),backgroundColor:so.map(c=>c.c),borderWidth:0,hoverOffset:6}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{position:'right',labels:{color:'#9a9ab0',font:{size:10,family:'Sarabun'},padding:8,boxWidth:12}}}}});
}
function rMonth(){
  const n=new Date(),lb=[],dN=[],dI=[];
  const tm=['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
  for(let i=5;i>=0;i--){const d=new Date(n.getFullYear(),n.getMonth()-i,1);const ms=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;lb.push(tm[d.getMonth()]);dN.push(S.exp.filter(e=>e.date.startsWith(ms)&&e.person==='namsai').reduce((s,e)=>s+e.amount,0));dI.push(S.exp.filter(e=>e.date.startsWith(ms)&&e.person==='iew').reduce((s,e)=>s+e.amount,0))}
  if(chM)chM.destroy();
  chM=new Chart(document.getElementById('chM'),{type:'line',data:{labels:lb,datasets:[{label:'‡∏ô‡πâ‡∏≥‡πÉ‡∏™',data:dN,borderColor:'#c2555a',backgroundColor:'rgba(194,85,90,0.08)',fill:true,tension:0.4,pointRadius:3,pointBackgroundColor:'#c2555a'},{label:'‡πÄ‡∏≠‡∏µ‡πà‡∏¢‡∏ß',data:dI,borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,0.08)',fill:true,tension:0.4,pointRadius:3,pointBackgroundColor:'#f59e0b'}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{labels:{color:'#9a9ab0',font:{size:10,family:'Sarabun'}}}},scales:{x:{ticks:{color:'#6a6a82',font:{size:9}},grid:{display:false}},y:{ticks:{color:'#6a6a82',font:{size:9},callback:v=>'‡∏ø'+v.toLocaleString()},grid:{color:'rgba(255,255,255,0.04)'}}}}});
}

// Tabs
function go(t){
  const ts=['add','hist','chart','set'],ids=['pAdd','pHist','pChart','pSet'];
  document.querySelectorAll('.nav-b').forEach((b,i)=>{
    const a=ts[i]===t;b.classList.toggle('act',a);b.classList.remove('u-namsai','u-iew');if(a)b.classList.add('u-'+S.cu);
  });
  ids.forEach((id,i)=>{const p=document.getElementById(id);if(p)p.classList.toggle('act',ts[i]===t)});
  if(t==='chart')rCharts();if(t==='hist')rHist();
}

// Settings
function svUrl(){S.url=document.getElementById('sUrl').value.trim();sv();ts('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!')}
function clr(){if(!confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?'))return;S.exp=[];sv();ua();ts('‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß')}

// Toast
function ts(m,e){const t=document.getElementById('tst');t.textContent=m;t.className='toast show'+(e==='e'?' err':'');setTimeout(()=>t.classList.remove('show'),2200)}

init();
</script>
</body>
</html>
